"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("lodash/debounce")),r=e(require("lodash/isEqual")),n=require("react"),o=e(require("lodash/noop")),a=e(require("url")),s=e(require("qs")),i=e(require("lodash/merge")),u=e(require("react-fast-compare")),l=e(require("lodash/isEqualWith"));function p(){return(p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function c(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function f(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var h=n.createContext({base:"",parentPath:"",resolve:function(e){return e},requestOptions:{},onError:o,onRequest:o,onResponse:o,queryParams:{},queryParamStringifyOptions:{}}),d=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t.prototype.render=function(){var e=this.props,t=e.children,r=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(o[r]=e[r]);return o}(e,["children"]);return n.createElement(h.Provider,{value:p({onError:o,onRequest:o,onResponse:o,resolve:function(e){return e},requestOptions:{},parentPath:"",queryParams:{},queryParamStringifyOptions:{}},r)},t)},t}(n.Component);d.displayName="RestfulProviderContext";var y=h.Consumer,m=function(e,t,r){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r="");var n=v(t,r);return""===e&&n.startsWith("/")?n:e.endsWith("/")?""+e.slice(0,-1)+n:""+e+n},v=function(e,t){return void 0===e&&(e=""),void 0===t&&(t=""),t.startsWith("/")&&t.length>1?a.resolve(e,t):""!==t&&"/"!==t?e+"/"+t:e},g=function(e){try{return 204===e.status?Promise.resolve({data:void 0,responseError:!1}):(e.headers.get("content-type")||"").includes("application/json")?Promise.resolve(f((function(){return Promise.resolve(e.json()).then((function(e){return{data:e,responseError:!1}}))}),(function(e){return{data:e.message,responseError:!0}}))):(e.headers.get("content-type")||"").includes("text/plain")||(e.headers.get("content-type")||"").includes("text/html")?Promise.resolve(f((function(){return Promise.resolve(e.text()).then((function(e){return{data:e,responseError:!1}}))}),(function(e){return{data:e.message,responseError:!0}}))):Promise.resolve({data:e,responseError:!1})}catch(e){return Promise.reject(e)}};function P(e,t,r,n){void 0===n&&(n={});var o=n.queryParamOptions,i=n.stripTrailingSlash,u=e.endsWith("/")?e:e+"/",l=t.startsWith("/")?t.slice(1):t,p=Object.keys(r||{}).length?l+"?"+s.stringify(r,o):l,c=Boolean(p)?a.resolve(u,p):u;return i&&c.endsWith("/")?c.slice(0,-1):c}var b=function(e){function o(r){var n;return(n=e.call(this,r)||this).abortController=new AbortController,n.signal=n.abortController.signal,n.state={data:null,response:null,loading:!n.props.lazy,error:null},n.getRequestOptions=function(e,t,r){try{var o=function(e){return a?e:p({},t,{},s,{headers:new Headers(p({},"boolean"!=typeof r?r:{},{},(t||{}).headers,{},(s||{}).headers))})},a=!1,s=n.props.requestOptions,i=function(){if("function"==typeof s)return Promise.resolve(s(e,"GET")).then((function(e){return a=!0,p({},t,{},e,{headers:new Headers(p({},"boolean"!=typeof r?r:{},{},(t||{}).headers,{},e.headers))})}))}();return Promise.resolve(i&&i.then?i.then(o):o(i))}catch(e){return Promise.reject(e)}},n.fetch=function(e,t){try{var r=n.props,o=r.base,a=r.__internal_hasExplicitBase,s=r.parentPath,i=r.path,u=r.resolve,l=r.onError,p=r.onRequest,c=r.onResponse;!n.state.error&&n.state.loading||n.setState((function(){return{error:null,loading:!0}}));var h=function(){var e=a?i:v(s,i);return P(o,e,n.props.queryParams,{stripTrailingSlash:!0,queryParamOptions:n.props.queryParamStringifyOptions})};return Promise.resolve(n.getRequestOptions(h(),t)).then((function(r){var o=new Request(h(),r);return p&&p(o),f((function(){return Promise.resolve(fetch(o,{signal:n.signal})).then((function(r){var o=r.clone();return c&&c(r.clone()),Promise.resolve(g(r)).then((function(a){var s=a.data,i=a.responseError;if(!n.signal.aborted){if(!r.ok||i){var p={message:"Failed to fetch: "+r.status+" "+r.statusText+(i?" - "+s:""),data:s,status:r.status};return n.setState({loading:!1,error:p,data:null,response:o}),!n.props.localErrorOnly&&l&&l(p,(function(){return n.fetch(e,t)}),r),null}return Promise.resolve(function(e){var t=e.data,r=e.resolve;try{var n=function(){return{data:o,error:a}},o=null,a=null,s=f((function(){var e=function(){if(r){var e=function(e){o=e},n=r(t);return n.then?Promise.resolve(n).then(e):e(n)}o=t}();if(e&&e.then)return e.then((function(){}))}),(function(e){o=null,a={message:"RESOLVE_ERROR",data:JSON.stringify(e)}}));return Promise.resolve(s&&s.then?s.then(n):n())}catch(e){return Promise.reject(e)}}({data:s,resolve:u})).then((function(e){return n.setState({loading:!1,data:e.data,error:e.error,response:o}),s}))}}))}))}),(function(e){n.signal.aborted||n.setState({loading:!1,data:null,error:{message:"Failed to fetch: "+e.message,data:e}})}))}))}catch(e){return Promise.reject(e)}},"object"==typeof r.debounce?n.fetch=t(n.fetch,r.debounce.wait,r.debounce.options):"number"==typeof r.debounce?n.fetch=t(n.fetch,r.debounce):r.debounce&&(n.fetch=t(n.fetch)),n}c(o,e);var a=o.prototype;return a.componentDidMount=function(){this.props.lazy||this.fetch()},a.componentDidUpdate=function(e){var t=e.resolve,n=e.requestOptions;(e.base!==this.props.base||e.parentPath!==this.props.parentPath||e.path!==this.props.path||!r(e.queryParams,this.props.queryParams)||t&&this.props.resolve&&t.toString()!==this.props.resolve.toString()||n&&this.props.requestOptions&&n.toString()!==this.props.requestOptions.toString())&&(this.props.lazy||this.fetch())},a.componentWillUnmount=function(){this.abortController.abort()},a.render=function(){var e=this.props,t=e.children,r=e.path,o=e.base,a=e.parentPath,s=this.state,i=s.data,u=s.error,l=s.loading,p=s.response;return e.wait&&null===i&&!u?n.createElement(n.Fragment,null):t(i,{loading:l,error:u},{refetch:this.fetch},{response:p,absolutePath:m(o,a,r)})},o}(n.Component);function q(e){return n.createElement(y,null,(function(t){return n.createElement(d,Object.assign({},t,{parentPath:v(t.parentPath,e.path)}),n.createElement(b,Object.assign({},t,e,{queryParams:p({},t.queryParams,{},e.queryParams),__internal_hasExplicitBase:Boolean(e.base),queryParamStringifyOptions:p({},t.queryParamStringifyOptions,{},e.queryParamStringifyOptions)})))}))}b.defaultProps={base:"",parentPath:"",resolve:function(e){return e},queryParams:{}};var O=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={data:null,previousData:null,loading:!t.props.lazy,lastResponse:null,polling:!t.props.lazy,finished:!1,error:null},t.keepPolling=!t.props.lazy,t.abortController=new AbortController,t.signal=t.abortController.signal,t.isModified=function(e,r){return 304!==e.status&&!u(t.state.data,r)},t.getRequestOptions=function(e){return"function"==typeof t.props.requestOptions?t.props.requestOptions(e,"GET"):t.props.requestOptions||{}},t.isResponseOk=function(e){return e.ok||304===e.status},t.cycle=function(){try{if(!t.keepPolling)return Promise.resolve();if(t.props.until&&t.props.until(t.state.data,t.state.lastResponse))return t.stop(),Promise.resolve();var e=t.props,r=e.interval,n=e.wait,o=e.onError,a=e.onRequest,s=e.onResponse,i=t.state.lastPollIndex,u=P(e.base,e.path,t.props.queryParams,{queryParamOptions:t.props.queryParamStringifyOptions,stripTrailingSlash:!0});return Promise.resolve(t.getRequestOptions(u)).then((function(e){var l=new Request(u,p({},e,{headers:p({Prefer:"wait="+n+"s;"+(i?"index="+i:"")},e.headers)}));return a&&a(l),f((function(){return Promise.resolve(fetch(l,{signal:t.signal})).then((function(e){return s&&s(e.clone()),Promise.resolve(g(e)).then((function(n){var a=n.data,s=n.responseError;if(t.keepPolling&&!t.signal.aborted){if(!t.isResponseOk(e)||s){var i={message:"Failed to poll: "+e.status+" "+e.statusText+(s?" - "+a:""),data:a,status:e.status};t.setState({loading:!1,lastResponse:e,error:i}),!t.props.localErrorOnly&&o&&o(i,(function(){return Promise.resolve()}),e)}else t.isModified(e,a)&&t.setState((function(t){return{loading:!1,lastResponse:e,previousData:t.data,data:a,error:null,lastPollIndex:e.headers.get("x-polling-index")||void 0}}));return Promise.resolve(new Promise((function(e){return setTimeout(e,r)}))).then((function(){t.cycle()}))}}))}))}),(function(){}))}))}catch(e){return Promise.reject(e)}},t.start=function(){t.keepPolling=!0,t.state.polling||t.setState((function(){return{polling:!0}})),t.cycle()},t.stop=function(){t.keepPolling=!1,t.setState((function(){return{polling:!1,finished:!0}}))},t}c(t,e);var r=t.prototype;return r.componentDidMount=function(){var e=this.props,t=e.lazy;if(void 0===e.path)throw new Error('[restful-react]: You\'re trying to poll something without a path. Please specify a "path" prop on your Poll component.');t||this.start()},r.componentWillUnmount=function(){this.abortController.abort(),this.stop()},r.render=function(){var e=this.state,t=e.lastResponse,r=e.previousData,n=e.data,o=e.polling,a=e.loading,s=e.error,i=e.finished,u=this.props,l=u.children,p=u.resolve,c={response:t,absolutePath:m(u.base,"",u.path)},f={polling:o,loading:a,error:s,finished:i},h={stop:this.stop,start:this.start};return l(t&&p?p(n,r):n,f,h,c)},t}(n.Component);O.defaultProps={interval:1e3,wait:60,base:"",resolve:function(e){return e},queryParams:{}};var E=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={loading:!1,error:null},t.abortController=new AbortController,t.signal=t.abortController.signal,t.mutate=function(e,r){try{var n=function(n){function o(o){function a(n){return Promise.resolve(g(s)).then((function(n){var o=n.data;if(!t.signal.aborted){if(!s.ok||n.responseError){var a={data:o,message:"Failed to fetch: "+s.status+" "+s.statusText,status:s.status};throw t.setState({error:a,loading:!1}),!t.props.localErrorOnly&&h&&h(a,(function(){return t.mutate(e,r)}),s),a}return t.setState({loading:!1}),t.props.onMutate&&t.props.onMutate(e,o),o}}))}var s,i=new Request(b(),p({method:l,body:q},n,{},r,{headers:p({"content-type":"object"==typeof e?"application/json":"text/plain"},"function"==typeof c?o.headers:o,{},r?r.headers:{})}));d&&d(i);var u=f((function(){return Promise.resolve(fetch(i,{signal:t.signal})).then((function(e){s=e,y&&y(s.clone())}))}),(function(n){var o={message:"Failed to fetch: "+n.message,data:""};throw t.setState({error:o,loading:!1}),!t.props.localErrorOnly&&h&&h(o,(function(){return t.mutate(e,r)})),o}));return u&&u.then?u.then(a):a()}return"function"==typeof c?Promise.resolve("function"==typeof c?c(b(),l,e):(c||{}).headers).then(o):o("function"==typeof c?c(b(),l,e):(c||{}).headers)},o=t.props,a=o.__internal_hasExplicitBase,s=o.base,i=o.parentPath,u=o.path,l=o.verb,c=o.requestOptions,h=o.onError,d=o.onRequest,y=o.onResponse,m=o.pathInlineBodyEncode;t.setState((function(){return{error:null,loading:!0}}));var b=function(){var r="DELETE"===l&&"string"==typeof e?v(u,m?m(e):e):u,n=a?r||"":v(i,r);return P(s,n,t.props.queryParams,{stripTrailingSlash:!0,queryParamOptions:t.props.queryParamStringifyOptions})},q="object"==typeof e?JSON.stringify(e):e;return Promise.resolve("function"==typeof c?Promise.resolve("function"==typeof c?c(b(),l,e):c).then(n):n("function"==typeof c?c(b(),l,e):c))}catch(e){return Promise.reject(e)}},t}c(t,e);var r=t.prototype;return r.componentWillUnmount=function(){this.abortController.abort()},r.render=function(){var e=this.props,t=this.state;return(0,e.children)(this.mutate,{loading:t.loading,error:t.error},{absolutePath:m(e.base,e.parentPath,e.path)})},t}(n.Component);function S(e,t){var r,o;n.useEffect(e,(r=t,o=n.useRef(),l(r,o.current,(function(e,t){if("function"==typeof e&&"function"==typeof t)return e.toString()===t.toString()}))||(o.current=r),o.current))}function R(){try{return new AbortController}catch(e){return}}function j(){var e=n.useRef(R());return{abort:n.useCallback((function(){e&&e.current&&(e.current.abort(),e.current=R())}),[e]),getAbortSignal:function(){var t;return null==e?void 0:null===(t=e.current)||void 0===t?void 0:t.signal}}}E.defaultProps={base:"",parentPath:"",path:"",queryParams:{}};var x=function e(t,r,n,o,a,s){try{var u=function(u){function l(l){var c=s(),h=new Request(R,i({},l,u,{signal:c}));return o.onRequest&&o.onRequest(h),f((function(){return Promise.resolve(fetch(h)).then((function(i){var u=i.clone();return o.onResponse&&o.onResponse(u),Promise.resolve(g(i)).then((function(l){var f=l.data,h=l.responseError;if(!c||!c.aborted){if(!i.ok||h){var d={message:"Failed to fetch: "+i.status+" "+i.statusText+(h?" - "+f:""),data:f,status:i.status};return n(p({},r,{loading:!1,data:null,error:d,response:u})),void(!t.localErrorOnly&&o.onError&&o.onError(d,(function(){return e(t,r,n,o,a,s)}),i))}n(p({},r,{error:null,loading:!1,data:y(f),response:u}))}}))}))}),(function(i){if(!c||!c.aborted){var u={message:"Failed to fetch: "+i.message,data:i.message};n(p({},r,{data:null,loading:!1,error:u})),!t.localErrorOnly&&o.onError&&o.onError(u,(function(){return e(t,r,n,o,a,s)}))}}))}return"function"==typeof o.requestOptions?Promise.resolve(o.requestOptions(R,"GET")).then(l):l(o.requestOptions)},l=t.base,c=void 0===l?o.base:l,h=t.path,d=t.resolve,y=void 0===d?function(e){return e}:d,m=t.queryParams,v=void 0===m?{}:m,b=t.queryParamStringifyOptions,q=void 0===b?{}:b,O=t.requestOptions,E=t.pathParams,S=void 0===E?{}:E;r.loading&&a(),!r.error&&r.loading||n(p({},r,{error:null,loading:!0}));var R=P(c,"function"==typeof h?h(S):h,p({},o.queryParams,{},v),{queryParamOptions:p({},o.queryParamStringifyOptions,{},q)});return Promise.resolve("function"==typeof O?Promise.resolve("function"==typeof O?O(R,"GET"):O).then(u):u("function"==typeof O?O(R,"GET"):O))}catch(e){return Promise.reject(e)}},w=function(e){return"function"==typeof e.cancel&&"function"==typeof e.flush};exports.Get=q,exports.Mutate=function(e){return n.createElement(y,null,(function(t){return n.createElement(d,Object.assign({},t,{parentPath:v(t.parentPath,e.path)}),n.createElement(E,Object.assign({},t,e,{queryParams:p({},t.queryParams,{},e.queryParams),queryParamStringifyOptions:p({},t.queryParamStringifyOptions,{},e.queryParamStringifyOptions),__internal_hasExplicitBase:Boolean(e.base)})))}))},exports.Poll=function(e){return n.createElement(y,null,(function(t){return n.createElement(O,Object.assign({},t,e,{queryParams:p({},t.queryParams,{},e.queryParams),requestOptions:function(r,n){try{var o=function(t){function o(e){return i(t,e)}return"function"==typeof e.requestOptions?Promise.resolve(e.requestOptions(r,n)).then(o):o(e.requestOptions||{})};return Promise.resolve("function"==typeof t.requestOptions?Promise.resolve(t.requestOptions(r,n)).then(o):o(t.requestOptions||{}))}catch(e){return Promise.reject(e)}},queryParamStringifyOptions:p({},t.queryParamStringifyOptions,{},e.queryParamStringifyOptions)}))}))},exports.RestfulProvider=d,exports.default=q,exports.useGet=function(){var e="object"==typeof arguments[0]?arguments[0]:p({},arguments[1],{path:arguments[0]}),r=n.useContext(h),o=e.path,a=e.pathParams,s=void 0===a?{}:a,i=n.useCallback("object"==typeof e.debounce?t(x,e.debounce.wait,e.debounce.options):"number"==typeof e.debounce?t(x,e.debounce):e.debounce?t(x):x,[e.debounce]);n.useEffect((function(){return w(i)?function(){return i.cancel()}:void 0}),[i]);var u=n.useState({data:null,response:null,loading:!e.lazy,error:null}),l=u[0],c=u[1],f=j(),d=f.abort,y=f.getAbortSignal,m="function"==typeof o?o(s):o;return S((function(){return e.lazy||e.mock||i(e,l,c,r,d,y),function(){d()}}),[e.lazy,e.mock,e.path,e.base,e.resolve,e.queryParams,e.requestOptions,e.pathParams,r.base,r.parentPath,r.queryParams,r.requestOptions,d]),p({},l,{},e.mock,{absolutePath:P(e.base||r.base,m,p({},r.queryParams,{},e.queryParams),{queryParamOptions:p({},r.queryParamStringifyOptions,{},e.queryParamStringifyOptions)}),cancel:function(){c(p({},l,{loading:!1})),d()},refetch:function(t){return void 0===t&&(t={}),i(p({},e,{},t),l,c,r,d,y)}})},exports.useMutate=function(){var e="object"==typeof arguments[0]?arguments[0]:p({},arguments[2],{path:arguments[1],verb:arguments[0]}),t=n.useContext(h),r=e.verb,o=e.base,a=void 0===o?t.base:o,s=e.path,u=e.queryParams,l=void 0===u?{}:u,c=e.resolve,d=e.pathParams,y=void 0===d?{}:d,m="DELETE"===r,v=n.useState({error:null,loading:!1}),b=v[0],q=v[1],O=j(),E=O.abort,S=O.getAbortSignal;n.useEffect((function(){return function(){return E()}}),[E]);var R=n.useCallback((function(n,o){try{var u=function(a){function s(r){function s(r){return Promise.resolve(g(u)).then((function(r){var o,a=r.data,s=r.responseError;try{o=c?c(a):a}catch(e){if(O&&O.aborted)return;var i={data:e.message,message:"Failed to resolve: "+e.message};throw q((function(e){return p({},e,{error:i,loading:!1})})),e}if(!O||!O.aborted){if(!u.ok||s){var l={data:o,message:"Failed to fetch: "+u.status+" "+u.statusText,status:u.status};throw q((function(e){return p({},e,{error:l,loading:!1})})),!e.localErrorOnly&&t.onError&&t.onError(l,(function(){return R(n)}),u),l}return q((function(e){return p({},e,{loading:!1})})),e.onMutate&&e.onMutate(n,o),o}}))}var u,l=new Request(j,i({},r,d,a,o,{signal:O}));t.onRequest&&t.onRequest(l);var h=f((function(){return Promise.resolve(fetch(l)).then((function(e){u=e,t.onResponse&&t.onResponse(u.clone())}))}),(function(r){var a={message:"Failed to fetch: "+r.message,data:""};throw q({error:a,loading:!1}),!e.localErrorOnly&&t.onError&&t.onError(a,(function(){return R(n,o)})),a}));return h&&h.then?h.then(s):s()}return"function"==typeof t.requestOptions?Promise.resolve(t.requestOptions(j,r,n)).then(s):s(t.requestOptions)};!b.error&&b.loading||q((function(e){return p({},e,{loading:!0,error:null})})),b.loading&&E();var h=["function"==typeof s?s((null==o?void 0:o.pathParams)||y):s],d={method:r};if(n instanceof FormData||(d.headers={"content-type":"object"==typeof n?"application/json":"text/plain"}),n instanceof FormData)d.body=n;else if("object"==typeof n)d.body=JSON.stringify(n);else if(m){var v=e.pathInlineBodyEncode?e.pathInlineBodyEncode(String(n)):String(n);h.push(v)}else d.body=n;var O=S(),j=P(a,h.join("/"),p({},t.queryParams,{},l,{},null==o?void 0:o.queryParams),{queryParamOptions:p({},t.queryParamStringifyOptions,{},e.queryParamStringifyOptions)});return Promise.resolve("function"==typeof e.requestOptions?Promise.resolve(e.requestOptions(j,r,n)).then(u):u(e.requestOptions))}catch(e){return Promise.reject(e)}}),[t.base,t.requestOptions,t.resolve,b.error,b.loading,s,E,S]);return p({},b,{mutate:R},e.mock,{cancel:function(){q((function(e){return p({},e,{loading:!1})})),E()}})};
//# sourceMappingURL=restful-react.cjs.production.min.js.map
